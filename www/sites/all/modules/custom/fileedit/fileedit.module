<?php
/**
 * @file
 * Code for the fileedit module.
 */

 
/**
* Implements hook_menu
*/ 
function fileedit_menu(){

  $items = array();
  
  $items['fileedit/edit/%'] = array(
    'page callback' => 'fileedit_edit',
    'page arguments' => array(2),
    'access callback' => 'fileedit_edit_access',
    'access arguments' => array(2),    //fid
    'type' => MENU_CALLBACK,
  );
  
  $items['fileedit/upload/%/%'] = array(
    'page callback' => 'fileedit_upload',
    'page arguments' => array(2,3),
    'access callback' => 'fileedit_upload_access',
    'access arguments' => array(2,3),    //fid, session ID
    'type' => MENU_CALLBACK,
  );
  
  $items['fileedit/download/%/%'] = array(
    'page callback' => 'fileedit_download',
    'page arguments' => array(2),
    'access callback' => 'fileedit_download_access',
    'access arguments' => array(2,3),    //fid, session ID
    'type' => MENU_CALLBACK,
  );
  
  $items['fileedit/check/%'] = array(
    'page callback'     => 'fileedit_check_clb',
    'page arguments'    => array(2),
    'access callback'   => TRUE,
    'type'              => MENU_CALLBACK,
  );
  
  $items['fileedit/getjarfile/%/%'] = array(
    'page callback' => 'fileedit_get_jars',
    'page arguments' => array(2,3), //filename of jar file, version string
    'access callback' => true, //access always ok
    'type' => MENU_CALLBACK,
  );
  
  return $items;
}
  
/**
* Implements hook_permission
*/
function fileedit_permission(){
  return array(
    'use file edit' => array(
      'title' => t('Allow edit files local'), 
      'description' => t('Shows an edit button on each file to edit it local'),
    ),
  );
}

/**
* implements hook_theme
*/
function fileedit_theme() {
  return array(
    'fileedit_xml' => array(
      'variables' => array('file' => false, 'args' => array()),
      'template' => 'fileedit_xml',
    )
  );
}

/**
* Access Callback URL for downloading URL
*/
function fileedit_download_access($fid, $sid) {

  //user must have a valid session ID
  $auser = _fileedit_user_by_sid($sid);
 
  if (!is_object($auser))
    return false;

  return _fileedit_file_edit_allowed($fid, $auser);
}

/**
* Access Callback for Edit Request
*/
function fileedit_edit_access($fid) {
  /*$general_access = user_access('use file edit');
  
  if (!$general_access)
    return false;*/
  
  global $user;
  $auser  = arg(3) ? _fileedit_user_by_sid( arg(3) ) : $user;

  return _fileedit_file_edit_allowed($fid, $auser);
}

/**
* Callback for Edit Request
*/
function fileedit_edit($fid,$sid=NULL) {    
  header("Cache-Control: no-cache, must-revalidate"); // HTTP/1.1
  header("Expires: Thu, 01 Jan 1970 00:00:01 GMT"); // Former times
  header("Content-type: application/x-java-jnlp-file");
  header("Last-Modified: " . time());
  
  global $user;
  //and then return the xml file
  $xml = _fileedit_get_edit_xml($fid, $sid?$sid:(arg(3)?arg(3):$user->sid) );
  die($xml);
}

/**
* Callback URL for downloading URL
*/
function fileedit_download($fid) {
  //dass es die Datei wirklich gibt, und wir hier auch Zugriff rauf haben
  //wurde schon in der fileedit_upload_access festgestellt!
  //ok die Datei gibt es wirklich!
  
  $file = file_load($fid);
  
  $headers = array(
    'Content-Type'              => 'force-download',
    'Content-Disposition'       => 'attachment; filename="' . $file->filename . '"',
    'Content-Length'            => $file->filesize,
    'Content-Transfer-Encoding' => 'binary',
    'Pragma'                    => 'no-cache',
    'Cache-Control'             => 'must-revalidate, post-check=0, pre-check=0',
    'Expires'                   => '0',
    'Accept-Ranges'             => 'bytes'
  );
  
  $uri      = $file->uri;//file_create_url( $file->uri );//drupal_realpath( $file->uri );//$file->uri;
  /*$scheme   = file_uri_scheme( $file->uri );
  
  if( $scheme && file_stream_wrapper_valid_scheme($scheme) ) {
    $wrapper  = file_stream_wrapper_get_instance_by_scheme( $scheme );
    $path     = $wrapper->getLocalPath( $file );
  }
  
  $uri      = $path;*/
  /*$parts  = explode( '://', $file->uri );
  //$parts  = array( $parts[0], implode( ':', array_slice( $parts, 1 ) ) );
  $exp    = explode( '/', $parts[1] );
  foreach( $exp as $i=>$s )
    $exp[$i]  = urlencode( $s );
  $uri    = $parts[0] . '://' . implode( '/', $exp );*/
  
  //file_put_contents( 'C:\xampp\htdocs\froebus_com_showroom\www\sites\all\modules\custom\showroom_helper\template\file.txt', print_r($file,1) );
  //file_put_contents( 'C:\xampp\htdocs\froebus_com_showroom\www\sites\all\modules\custom\showroom_helper\template\url.txt', print_r($uri,1) );
  
  file_transfer( $uri, $headers );
  
}

/**
 * Callback URL for uploading URL
 *
 *  @TODO evaluate whether a drupal_submit_form after readjusting the _FILES-array might be easier/less error-prone
 */
function fileedit_upload( $fid, $sid ) {
  // Thiemo; Save updates, reload page
  session_id( $sid );
  session_start();
  drupal_save_session( TRUE );
  
  $_SESSION['fileedit']['updated'][$fid]  = TRUE;
  
  // Thiemo; Fancy revision handling
  $revisions    = array();
  $file_then    = file_load( $fid );
  $per_module   = file_usage_list( $file_then );
  
  foreach( $per_module as $module=>$per_type ) {
    foreach( $per_type as $type=>$per_type_id ) {
      foreach( $per_type_id as $id=>$count ) {
        //dpm( $id );
        if( $type=='node' ) {
          $node     = node_load( $id );
          //file_put_contents( 'C:\xampp\htdocs\froebus_com_showroom\www\sites\all\modules\custom\showroom_helper\template\loading.txt', "\n".$node->type." = ".$node->nid, FILE_APPEND );
          $options  = variable_get( 'node_options_' . $node->type, array() );
          if( in_array( 'revision', $options ) )
            $revisions[]    = array( $node, $node, $type );
        }
        elseif( $type=='field_collection_item' ) {
          $entities     = array_values( entity_load( 'field_collection_item', array( $id ) ) );
          $root_entity  = $entities[0];
          $entity       = $root_entity;
          // Yo dawg...
          while( ($node=$entity->hostEntity()) && $entity->hostEntityType!='node' )
            $entity = $node;
          
          if( $node ) {
            $options  = variable_get( 'node_options_' . $node->type, array() );
            if( in_array( 'revision', $options ) ) {
              $revisions[]  = array( $node, $root_entity, $type );
            }
          }
        }
        // @TODO Someone smart would allow drop-ins here
        // else ???
      }
    }
  }
  
  if( count($revisions) ) {
    
    // Thiemo; Bad revisioning if the user isn't known...
    global $user;
    $user = _fileedit_user_by_sid( $sid );
    
    $name   = 'userfile';
    
    // Make it a multiple-upload form submit...
    $_FILES = array(
      'files' => array(
        'name'  => array(
          $name   => $file_then->filename, //$_FILES[$name]['name'],
        ),
        'type' => array(
          $name   => $_FILES[$name]['type'],
        ),
        'tmp_name' => array(
          $name   => $_FILES[$name]['tmp_name'],
        ),
        'error' => array(
          $name   => $_FILES[$name]['error'],
        ),
        'size'  => array(
          $name   => $_FILES[$name]['size'],
        ),
      ),
    );
    
    foreach( $revisions as $collection ) {
      $node     = $collection[0];
      $entity   = $collection[1];
      $type     = $collection[2];
      $changed  = false;
      
      foreach( (array)$entity as $name=>$value ) {
        if( substr($name,0,6)=='field_' ) {
          $info     = field_info_field( $name );
          if( $info['type']=='file' && isset($value[LANGUAGE_NONE]) ) {
            foreach( $value[LANGUAGE_NONE] as $delta=>$file ) {
              if( $file['fid']==$fid ) {
                $instance     = field_info_instance( $type, $name, $node->type );
                $destination  = file_field_widget_uri( $info, $instance );
                $validators   = file_field_widget_upload_validators( $info, $instance );
                //file_put_contents( 'C:\xampp\htdocs\froebus_com_showroom\www\sites\all\modules\custom\showroom_helper\template\file-go.txt', print_r(array($_FILES,$file_then,$info,$instance,$destination,$validators),1) );
                $file_now     = file_save_upload( /*$file_then->filename*/'userfile', $validators, $destination );
                //file_put_contents( 'C:\xampp\htdocs\froebus_com_showroom\www\sites\all\modules\custom\showroom_helper\template\file-now.txt', print_r($file_now,1) );
                
                if( $file_now ) {
                  $changed      = true;
                  $field        = &$entity->$name;
                  $field[LANGUAGE_NONE][$delta]['fid']  = $file_now->fid;
                }
              }
            }
          }
        }
      }
      
      if( $changed ) {
        $entity->revision = TRUE;
        
        if( $type=='node' )
          node_save( $entity );
        else
          $entity->save();
        
        if( $node!=$entity ) {
          $node->revision   = TRUE;
          node_save( $node );
        }
      }
    }
    
    //session_write_close();
    die();
    
  }
  
  
  //print_r($_FILES);
  $tmp_name = $_FILES['userfile']['tmp_name'];
  
  //load the file
  $file = file_load($fid);
  $uri = $file->uri;
  //save the new file back to its uri
  drupal_move_uploaded_file($tmp_name, $uri);
  
  //print_r($file);
  
  //session_write_close();
  die();
  echo $fid."--".$tmp_name;
  die();

  //@todo do something if the file was not uploaded successfully
  
  
  //file_save_upload($tmp_name, );
}

/**
 *  Check whether the given files were updated by the current user
 */
function fileedit_check_clb( $fids ) {
  $fids = explode( ' ', $fids );
  
  //die( print_r( $_SESSION, 1 ) );
  
  foreach( $fids as $fid ) {
    $fid  = $fid.'';
    if( isset($_SESSION['fileedit']['updated'][$fid]) && $_SESSION['fileedit']['updated'][$fid] )
      die( '1' );
  }
  
  die( '0' );
}

/**
* Access Callback URL for uploading URL
*/
function fileedit_upload_access($fid, $sid) {
  
  //user must have a valid session ID
  $auser = _fileedit_user_by_sid($sid);

  if (!is_object($auser))
    return false;
  
  return _fileedit_file_edit_allowed($fid, $auser);
}

/**
* Checks if the user has rights to edit this file
*/
function _fileedit_file_edit_allowed($fid, $auser=false) {
  if (!$auser) {
    global $user;
    $auser = $user;
  }

  if (!user_access('use file edit', $auser))
    return false;  //use has no rights, so change nothing here

  $fid  = intval($fid);
  $file = file_load($fid);

  //@TODO: prüfen dass der user nicht nur laden sondern auch speichern / editieren darf!!
  
  if (empty($fid) || empty($file) || !$file->status) {
    return false;
  }
  
  //@todo wirklich prüfen, ob der user genau diese Datei auch bearbeiten darf!
  
  return true;  
}

/**
* Implements hook_theme_registry_alter
*/
function fileedit_theme_registry_alter(&$registry) {
  
  $registry['file_link']['preprocess functions'][] = 'fileedit_file_link_preprocess';
  $registry['file_link']['function'] = 'theme_file_link_fileedit';
  
}

/**
* Preprocess function für file_link theme
*/
function fileedit_file_link_preprocess(&$variables) {
  global $user;
  $file = $variables['file'];

  if (!_fileedit_file_edit_allowed($file->fid))
    return;  //use has no rights, so change nothing here
  
  //add the link to edit the file!
  
  $edit_url = _fileedit_edit_url($file);
  $variables['edit_url'] = $edit_url;
}

function _fileedit_get_edit_xml($file,$sid) {
  
  global $user;
  $module_path = drupal_get_path('module', 'fileedit');
  $upload_url = $module_path.'/';
  
  //perhaps it is a file id only
  if (!is_object($file))
    $file = file_load($file);
  
  $args = _fileedit_get_jar_urls();
  $args['arguments']['download'] = _fileedit_download_url($file)."/".$sid;
  $args['arguments']['upload'] = _fileedit_upload_url($file)."/".$sid;
  $args['arguments']['session'] = $sid;
  $args['arguments']['fid'] = $file->fid;
  $args['arguments']['filename'] = $file->filename;
  $edit_url = _fileedit_edit_url($file);
  if ($sid)
    $edit_url .= '/'.$sid;
  $args['arguments']['edit_url'] = $edit_url;
  $xml = theme('fileedit_xml', array('file' => $file, 'args' => $args));
  
  return $xml;
}

/**
* Return the download URL
*/
function _fileedit_download_url($file) {
  return url('fileedit/download/'.$file->fid, array('absolute' => true));
}

/**
* Return the download URL
*/
function _fileedit_upload_url($file) {
  return url('fileedit/upload/'.$file->fid, array('absolute' => true));
}

/**
* Return the edit URL
*/
function _fileedit_edit_url($file) {
  return url('fileedit/edit/'.$file->fid, array('absolute' => true));
}

/**
* returns the URLs to the jar files neede for fileedit
*/
function _fileedit_get_jar_urls() {
  
  //$module_path = drupal_get_path('module', 'fileedit');
  
  //deliver jar files with php script  to control response header
  return array(
    'commons_logging_jar_url' => url('fileedit/getjarfile/commons-logging/1.1.1', array('absolute' => true)),
    'httpclient_jar_url' => url('fileedit/getjarfile/httpclient/4.1.2', array('absolute' => true)),
    'httpcore_jar_url' => url('fileedit/getjarfile/httpcore/4.1.2', array('absolute' => true)),
    'filehandler_jar_url' => url('fileedit/getjarfile/FileHandler/0.0.1', array('absolute' => true)),
    'httpmime_jar_url' => url('fileedit/getjarfile/httpmime/4.1.2', array('absolute' => true)),
  );
  
}

/**
* theming function top theme a file link with fileedit
*/
function theme_file_link_fileedit(&$variables) {
  
  $out  = !isset($variables['hide_download_link']) ? theme_file_link($variables) . ' ' : '';
  
  $edit_link  = '';
  $edit_url   = '';
  if (isset($variables['edit_url'])) {
    static $js_inc  = false;
    if( !$js_inc ) {
      $js_inc     = true;
      drupal_add_js( drupal_get_path('module','fileedit').'/js/update-page-on-file-edit.js' );
      drupal_add_js( array( 'fileedit'=>array( 'updateURL'=>url('fileedit/check', array('absolute' => true)).'/' ) ), 'setting' );
    }
    
    $edit_url   = $variables['edit_url'];  
    $edit_link  = l( t('Edit'), $edit_url, array('attributes'=>array('class'=>array('fileedit-link'))) );
    
    $out        .= $edit_link;
  }
  
  return $out;
  
}

/**
* returns the User logged in with a session ID
* @see mostly copied from session.inc _drupal_session_read()
*/
function _fileedit_user_by_sid($sid) {

  global $is_https;

  // Write and Close handlers are called after destructing objects
  // since PHP 5.0.5.
  // Thus destructors can use sessions but session handler can't use objects.
  // So we are moving session closure before destructing objects.
  drupal_register_shutdown_function('session_write_close');


  // Otherwise, if the session is still active, we have a record of the
  // client's session in the database. If it's HTTPS then we are either have
  // a HTTPS session or we are about to log in so we check the sessions table
  // for an anonymous session with the non-HTTPS-only cookie.
  if ($is_https) {
    $user = db_query("SELECT u.*, s.* FROM {users} u INNER JOIN {sessions} s ON u.uid = s.uid WHERE s.ssid = :ssid", array(':ssid' => $sid))->fetchObject();
    if (!$user) {
      if (isset($_COOKIE[$insecure_session_name])) {
        $user = db_query("SELECT u.*, s.* FROM {users} u INNER JOIN {sessions} s ON u.uid = s.uid WHERE s.sid = :sid AND s.uid = 0", array(
          ':sid' => $_COOKIE[$insecure_session_name],
        ))
        ->fetchObject();
      }
    }
  }
  else {
    $user = db_query("SELECT u.*, s.* FROM {users} u INNER JOIN {sessions} s ON u.uid = s.uid WHERE s.sid = :sid", array(':sid' => $sid))->fetchObject();
  }

  return $user;
}

/**
* endpoint for requesting a jar file within webstart ja
*/
function fileedit_get_jars($filename, $version_string) {
  //send the header
  
  $modpath = drupal_get_path('module', 'fileedit');
  $filename = $modpath."/jar/".$filename . "-" . $version_string . ".jar";
  
  //get the file, must be located in jar folder
  //send version header
  header("x-java-jnlp-version-id: ".$version_string);
  header("Content-Transfer-Encoding: binary");
  header("Pragma: no-cache");
  header("Accept-Ranges: bytes");

  //send file
  if (file_exists($filename))
    readfile($filename);
  else
	echo "file not found: ".$filename; 
}